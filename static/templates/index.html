<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Annotation Tool</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    .navigation {
      text-align: center;
      margin-bottom: 20px;
    }
    .navigation a {
      color: #007bff;
      text-decoration: none;
      margin: 0 10px;
      padding: 8px 16px;
      border: 1px solid #007bff;
      border-radius: 6px;
      display: inline-block;
    }
    .navigation a:hover {
      background: #007bff;
      color: white;
    }
    .navigation a.active {
      background: #007bff;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé¨ Video Annotation Tool</h1>
    
    <div class="navigation">
      <a href="/" class="active">üìπ Video Annotations</a>
      <a href="/script-generator">üéôÔ∏è Script Generator</a>
    </div>
    
    <!-- Debug info -->
    <div id="debug" style="background: #f0f0f0; padding: 10px; margin-bottom: 20px;">
      <h3>Debug Info:</h3>
      <p>Current URL: <span id="currentUrl"></span></p>
      <p>API Base: <span id="apiBaseDisplay"></span></p>
      <p>Last Response: <span id="lastResponse"></span></p>
    </div>
    
    <!-- Add new video -->
    <section>
      <h2>Add a New Video</h2>
      <form id="videoForm">
        <input type="text" id="title" placeholder="Video Title" required>
        <input type="text" id="video_url" placeholder="Video URL (optional)">
        <button type="submit">Save Video</button>
      </form>
    </section>
    
    <!-- Select video -->
    <section>
      <h2>Annotate a Video</h2>
      <select id="videoSelect">
        <option value="">-- Select a video --</option>
      </select>
      <form id="annotationForm" style="margin-top: 1em;">
        <input type="number" id="start_time" placeholder="Start (sec)" step="0.1" required>
        <input type="number" id="end_time" placeholder="End (sec)" step="0.1" required>
        <input type="text" id="description" placeholder="Description" required>
        <button type="submit">Save Annotation</button>
      </form>
    </section>
    
    <!-- Show annotations -->
    <section>
      <h2>Annotations</h2>
      <ul id="annotationList"></ul>
    </section>
    
    <!-- Edit Annotation Modal -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; width: 400px; max-width: 90%;">
        <h3>Edit Annotation</h3>
        <form id="editAnnotationForm">
          <input type="hidden" id="editAnnotationId">
          <input type="number" id="editStartTime" placeholder="Start (sec)" step="0.1" required>
          <input type="number" id="editEndTime" placeholder="End (sec)" step="0.1" required>
          <textarea id="editDescription" placeholder="Description" required rows="3"></textarea>
          <div style="margin-top: 15px;">
            <button type="submit" style="background: #28a745;">Save Changes</button>
            <button type="button" id="cancelEdit" style="background: #6c757d; margin-left: 10px;">Cancel</button>
            <button type="button" id="deleteAnnotation" style="background: #dc3545; margin-left: 10px;">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    const apiBase = "";
    
    // Debug info
    document.getElementById("currentUrl").textContent = window.location.href;
    document.getElementById("apiBaseDisplay").textContent = apiBase || "empty (relative URLs)";
    
    function updateDebug(message) {
      document.getElementById("lastResponse").textContent = message;
      console.log("Debug:", message);
    }
    
    // Enhanced fetch with error handling
    async function apiRequest(url, options = {}) {
      try {
        updateDebug(`Making request to: ${apiBase}${url}`);
        const response = await fetch(`${apiBase}${url}`, options);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        updateDebug(`Success: ${JSON.stringify(data).substring(0, 100)}...`);
        return data;
      } catch (error) {
        updateDebug(`Error: ${error.message}`);
        console.error("API Error:", error);
        alert(`API Error: ${error.message}`);
        throw error;
      }
    }
    
    // Fetch and populate videos
    async function loadVideos() {
      try {
        const videos = await apiRequest("/videos");
        const select = document.getElementById("videoSelect");
        select.innerHTML = `<option value="">-- Select a video --</option>`;
        videos.forEach(v => {
          select.innerHTML += `<option value="${v.id}">${v.title}</option>`;
        });
        updateDebug(`Loaded ${videos.length} videos`);
      } catch (error) {
        updateDebug(`Failed to load videos: ${error.message}`);
      }
    }
    
    // Add new video
    document.getElementById("videoForm").addEventListener("submit", async e => {
      e.preventDefault();
      try {
        const title = document.getElementById("title").value;
        const video_url = document.getElementById("video_url").value;
        
        await apiRequest("/videos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, video_url })
        });
        
        document.getElementById("videoForm").reset();
        loadVideos();
        updateDebug("Video created successfully");
      } catch (error) {
        updateDebug(`Failed to create video: ${error.message}`);
      }
    });
    
    // Add annotation
    document.getElementById("annotationForm").addEventListener("submit", async e => {
      e.preventDefault();
      const videoId = document.getElementById("videoSelect").value;
      if (!videoId) { 
        alert("Select a video first!"); 
        return; 
      }
      
      try {
        const start_time = parseFloat(document.getElementById("start_time").value);
        const end_time = parseFloat(document.getElementById("end_time").value);
        const description = document.getElementById("description").value;
        
        await apiRequest(`/videos/${videoId}/annotations`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ start_time, end_time, description })
        });
        
        document.getElementById("annotationForm").reset();
        loadAnnotations(videoId);
        updateDebug("Annotation created successfully");
      } catch (error) {
        updateDebug(`Failed to create annotation: ${error.message}`);
      }
    });
    
    // Load annotations for selected video
    document.getElementById("videoSelect").addEventListener("change", e => {
      const videoId = e.target.value;
      if (videoId) loadAnnotations(videoId);
    });
    
    async function loadAnnotations(videoId) {
      try {
        const annotations = await apiRequest(`/videos/${videoId}/annotations`);
        const list = document.getElementById("annotationList");
        list.innerHTML = "";
        annotations.forEach(a => {
          list.innerHTML += `
            <li style="position: relative; cursor: pointer;" onclick="openEditModal('${a.id}', ${a.start_time}, ${a.end_time}, '${a.description.replace(/'/g, "\\'")}')">
              [${a.start_time}s - ${a.end_time}s] (Duration: ${a.duration}s) ‚Üí ${a.description}
              <span style="color: #007bff; font-size: 12px; margin-left: 10px;">‚úèÔ∏è Click to edit</span>
            </li>`;
        });
        updateDebug(`Loaded ${annotations.length} annotations`);
      } catch (error) {
        updateDebug(`Failed to load annotations: ${error.message}`);
      }
    }
    
    // Edit annotation functions
    function openEditModal(id, startTime, endTime, description) {
      document.getElementById("editAnnotationId").value = id;
      document.getElementById("editStartTime").value = startTime;
      document.getElementById("editEndTime").value = endTime;
      document.getElementById("editDescription").value = description;
      document.getElementById("editModal").style.display = "block";
    }
    
    function closeEditModal() {
      document.getElementById("editModal").style.display = "none";
    }
    
    // Edit form handler
    document.getElementById("editAnnotationForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("editAnnotationId").value;
      const start_time = parseFloat(document.getElementById("editStartTime").value);
      const end_time = parseFloat(document.getElementById("editEndTime").value);
      const description = document.getElementById("editDescription").value;
      
      try {
        await apiRequest(`/annotations/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ start_time, end_time, description })
        });
        
        closeEditModal();
        const videoId = document.getElementById("videoSelect").value;
        if (videoId) loadAnnotations(videoId);
        updateDebug("Annotation updated successfully");
      } catch (error) {
        updateDebug(`Failed to update annotation: ${error.message}`);
      }
    });
    
    // Cancel edit
    document.getElementById("cancelEdit").addEventListener("click", closeEditModal);
    
    // Delete annotation
    document.getElementById("deleteAnnotation").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete this annotation?")) return;
      
      const id = document.getElementById("editAnnotationId").value;
      try {
        await apiRequest(`/annotations/${id}`, { method: "DELETE" });
        closeEditModal();
        const videoId = document.getElementById("videoSelect").value;
        if (videoId) loadAnnotations(videoId);
        updateDebug("Annotation deleted successfully");
      } catch (error) {
        updateDebug(`Failed to delete annotation: ${error.message}`);
      }
    });
    
    // Close modal when clicking outside
    document.getElementById("editModal").addEventListener("click", (e) => {
      if (e.target.id === "editModal") closeEditModal();
    });
    
    // Initial load
    updateDebug("Page loaded, attempting to load videos...");
    loadVideos();
  </script>
</body>
</html>
